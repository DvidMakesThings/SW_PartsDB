{% extends "base.html" %}
{% block title %}{% if mode == 'edit' %}Edit {{ part.dmtuid }}{% elif template_part %}Add Part (from {{
template_part.dmtuid }}){% else %}Add Part{% endif %} - DMTDB{% endblock %}

{% block content %}
<div class="page-header">
  <h1>{% if mode == 'edit' %}Edit {{ part.dmtuid }}{% elif template_part %}Add New Part <span
      style="font-size:.7em; color:var(--text-dim);">(from {{ template_part.dmtuid }})</span>{% else %}Add New Part{%
    endif %}</h1>
</div>

<form method="post" id="partForm">

  <!-- Classification -->
  <div class="detail-card" style="margin-bottom:1rem;">
    <h2>Classification (DMTUID)</h2>
    {% if mode == 'edit' %}
    <p style="font-family:var(--mono); font-size:1.1rem; color:var(--accent); margin-bottom:.75rem;">{{ part.dmtuid }}
    </p>
    <p style="color:var(--text-dim); font-size:.85rem;">Classification cannot be changed after creation.</p>
    {% else %}
    <div class="form-grid">
      <div class="form-group">
        <label>Domain (TT)</label>
        <select name="tt" id="ttSel" required>
          <option value="">Select domain…</option>
          {% for dom in domains %}
          <option value="{{ dom.tt }}">{{ dom.tt }} - {{ dom.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Family (FF)</label>
        <select name="ff" id="ffSel" required>
          <option value="">Select family…</option>
        </select>
      </div>
      <div class="form-group">
        <label>Class (CC)</label>
        <select name="cc" id="ccSel" required>
          <option value="">Select class…</option>
        </select>
      </div>
      <div class="form-group">
        <label>Style (SS)</label>
        <select name="ss" id="ssSel" required>
          <option value="">Select style…</option>
        </select>
      </div>
    </div>
    <p style="color:var(--text-dim); font-size:.85rem; margin-top:.5rem;">XXX sequence number will be auto-assigned.</p>
    {% endif %}
  </div>

  <!-- Core Fields -->
  <div class="detail-card" style="margin-bottom:1rem;">
    <h2>Core Fields</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>MPN</label>
        <input type="text" name="MPN" value="{{ part.mpn if part else '' }}">
      </div>
      <div class="form-group">
        <label>Value</label>
        <input type="text" name="Value" value="{{ part.value if part else '' }}">
      </div>
      <div class="form-group">
        <label>Manufacturer</label>
        <input type="text" name="Manufacturer" value="{{ part.manufacturer if part else '' }}">
      </div>
      <div class="form-group">
        <label>Quantity</label>
        <input type="text" name="Quantity" value="{{ part.quantity if part else '' }}">
      </div>
      <div class="form-group">
        <label>Location</label>
        <input type="text" name="Location" value="{{ part.location if part else '' }}">
      </div>
      <div class="form-group">
        <label>Datasheet (URL or local filename)</label>
        <input type="text" name="Datasheet" value="{{ part.datasheet if part else '' }}">
      </div>
      <div class="form-group">
        <label>Distributor URL (DigiKey, Mouser, etc.)</label>
        <input type="text" name="Distributor" value="{{ part.distributor if part else '' }}">
      </div>
      <div class="form-group full">
        <label>Description</label>
        <textarea name="Description" rows="2">{{ part.description if part else '' }}</textarea>
      </div>
    </div>
  </div>

  <!-- Template Fields -->
  <div class="detail-card" style="margin-bottom:1rem;" id="templateFieldsCard">
    <h2>Template Fields <span id="templateLabel"
        style="font-weight:400; font-size:.75rem; color:var(--text-dim);"></span></h2>
    <div class="form-grid" id="templateFields">
      {% if mode == 'edit' and template_fields %}
      {% set field_map = {} %}
      {% for f in part.fields %}
      {% if field_map.update({f.field_name: f.field_value}) %}{% endif %}
      {% endfor %}
      {% set skip =
      ['MPN','Location','Quantity','Value','Manufacturer','Description','Datasheet','RoHS','TT','FF','CC','SS','XXX','DMTUID']
      %}
      {% for fname in template_fields %}
      {% if fname not in skip %}
      <div class="form-group">
        <label>{{ fname }}</label>
        <input type="text" name="{{ fname }}" value="{{ field_map.get(fname, '') }}">
      </div>
      {% endif %}
      {% endfor %}
      {% else %}
      <p style="color:var(--text-dim); font-size:.85rem;" id="templatePlaceholder">
        Select a Domain and Family above to load template fields.
      </p>
      {% endif %}
    </div>
  </div>

  <!-- KiCad -->
  <div class="detail-card" style="margin-bottom:1rem;">
    <h2>KiCad Integration</h2>

    <div class="kicad-dropzone" id="kicadDropzone">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" y1="3" x2="12" y2="15" />
      </svg>
      <p>Drop .kicad_sym, .kicad_mod, .step files here</p>
      <div class="kicad-upload-status" id="kicadUploadStatus"></div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label>KiCad Symbol</label>
        <div class="input-with-dropdown">
          <input type="text" name="kicad_symbol" id="kicadSymbolInput" value="{{ part.kicad_symbol if part else '' }}"
            placeholder="Auto-generated from Value (drag .kicad_sym to customize)">
          <!-- Symbol dropdown hidden - consolidated libs are too large to browse -->
        </div>
      </div>
      <div class="form-group">
        <label>KiCad Footprint</label>
        <div class="input-with-dropdown">
          <input type="text" name="kicad_footprint" id="kicadFootprintInput"
            value="{{ part.kicad_footprint if part else (template_part.kicad_footprint if template_part else '') }}"
            placeholder="e.g. DMTDB:Footprint">
          <select id="footprintSelect" title="Select existing footprint">
            <option value="">-- Select existing --</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>LCSC Part</label>
        <input type="text" name="kicad_libref" id="lcscPartInput" value="{{ part.kicad_libref if part else '' }}"
          placeholder="e.g. C12345">
      </div>
      <div class="form-group">
        <label>KiCad 3D Model</label>
        <div class="input-with-dropdown">
          <input type="text" name="kicad_3dmodel" id="kicad3dmodelInput"
            value="{{ part.kicad_3dmodel if part else (template_part.kicad_3dmodel if template_part else '') }}"
            placeholder="e.g. C_1206_3216Metric.step">
          <select id="model3dSelect" title="Select existing 3D model">
            <option value="">-- Select existing --</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="detail-card" style="margin-bottom:1rem;">
    <h2>Notes</h2>
    <div class="form-group full">
      <textarea name="notes" rows="3">{{ part.notes if part else '' }}</textarea>
    </div>
  </div>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">{% if mode == 'edit' %}Save Changes{% else %}Create Part{% endif
      %}</button>
    {% if mode == 'edit' %}
    <a href="/part/{{ part.dmtuid }}" class="btn btn-secondary">Cancel</a>
    {% else %}
    <a href="/" class="btn btn-secondary">Cancel</a>
    {% endif %}
  </div>
</form>

<!-- Symbol Property Editor Modal -->
<div class="modal-overlay" id="symbolEditorModal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Symbol Properties</h3>
      <button type="button" class="modal-close" id="symbolEditorClose">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-hint">Edit properties before saving. Values auto-filled from part data where available.</p>
      <div class="symbol-props-grid" id="symbolPropsGrid">
        <!-- Dynamic property fields -->
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="symbolEditorCancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="symbolEditorSave">Save Symbol</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>var domainsData = {{ domains | tojson | safe }};</script>
{% if template_part %}
<script>var templatePartData = {
    tt: "{{ template_part.tt }}",
    ff: "{{ template_part.ff }}",
    cc: "{{ template_part.cc }}",
    ss: "{{ template_part.ss }}"
  };</script>
{% else %}
<script>var templatePartData = null;</script>
{% endif %}
<script src="/static/js/add_edit.js"></script>
{% endblock %}