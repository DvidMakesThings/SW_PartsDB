{% extends "base.html" %}
{% block title %}API Documentation - DMTDB{% endblock %}

{% block content %}
<div class="page-header">
  <h1>REST API Documentation</h1>
  <span class="subtitle">Base URL: <code style="color:var(--accent);">/api/v1</code></span>
</div>

<!-- DMTUID Format -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>DMTUID Format</h2>
  <p style="font-size:.9rem; margin-bottom:.5rem;">Pattern: <code
      style="color:var(--accent); font-size:1.1rem;">DMT-TTFFCCSSXXX</code></p>
  <div class="field-row"><span class="field-label">TT (00-99)</span><span class="field-value">Top domain</span></div>
  <div class="field-row"><span class="field-label">FF (00-99)</span><span class="field-value">Family inside
      domain</span></div>
  <div class="field-row"><span class="field-label">CC (00-99)</span><span class="field-value">Class or subtype</span>
  </div>
  <div class="field-row"><span class="field-label">SS (00-99)</span><span class="field-value">Style or vendor
      bucket</span></div>
  <div class="field-row"><span class="field-label">XXX (001-999)</span><span class="field-value">Per-item sequence
      (auto-assigned)</span></div>
</div>

<!-- Schema Endpoints -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>Schema Endpoints</h2>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/schema/domains</code> — List all domains and families</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/schema/template/{ttff}</code> — Get template fields for a TT+FF key</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/schema/guidelines/{ttff}</code> — Get CC/SS guidelines for a family</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/schema/cross_cutting</code> — List cross-cutting class codes (90-99)</span>
  </div>
</div>

<!-- Parts CRUD -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>Parts CRUD</h2>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/parts?q=&amp;tt=&amp;ff=&amp;sort=&amp;order=&amp;limit=100&amp;offset=0</code>
      — List/search
      parts</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/parts/{dmtuid}</code> — Get a single part by DMTUID</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/parts</code> — Create new part (JSON: tt, ff, cc, ss + fields). XXX
      auto-assigned.</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--accent);">PUT</span><span
      class="field-value"><code>/api/v1/parts/{dmtuid}</code> — Update fields (JSON body)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--red);">DELETE</span><span
      class="field-value"><code>/api/v1/parts/{dmtuid}</code> — Delete a part</span></div>
  <p style="color:var(--text-dim); font-size:.85rem; margin-top:.75rem;">
    <strong>Sort params:</strong> <code>sort</code> = dmtuid | created_at | MPN | Value | Manufacturer | Package |
    Location | props<br>
    <code>order</code> = asc | desc
  </p>
</div>

<!-- KiCad HTTP Library -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>KiCad HTTP Library</h2>
  <p style="color:var(--text-dim); font-size:.85rem; margin-bottom:.75rem;">
    Configure in KiCad: Preferences → Manage Symbol Libraries → Add HTTP Library<br>
    URL: <code style="color:var(--accent);">http://&lt;server&gt;:5000/kicad/v1</code>
  </p>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/kicad/v1/</code> — Root endpoint (API info)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/kicad/v1/categories.json</code> — List categories (Domain/Family)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/kicad/v1/parts.json</code> — List all parts with symbols</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/kicad/v1/parts/category/{ttff}.json</code> — Parts in category</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/kicad/v1/parts/{dmtuid}.json</code> — Part detail with KiCad fields</span></div>
</div>

<!-- KiCad Programmatic Search -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>KiCad Search API</h2>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/kicad/search?q=&amp;mpn=&amp;value=&amp;manufacturer=</code> — Multi-criteria
      search</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/kicad/instock</code> — Parts with Quantity &gt; 0</span></div>
  <p style="color:var(--text-dim); font-size:.85rem; margin-top:.75rem;">
    Returns KiCad-friendly records: <code>kicad_symbol</code>, <code>kicad_footprint</code>, <code>kicad_3dmodel</code>,
    <code>kicad_libref</code>
  </p>
</div>

<!-- Label Printing -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>Label Printing</h2>
  <p style="color:var(--text-dim); font-size:.85rem; margin-bottom:.75rem;">
    Generate labels with Code 128 barcodes in multiple sizes (50×30mm, 75×50mm, 100×50mm, 4"×6").
  </p>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/labels</code> — Label printing page with search and filtering</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/labels/svg/{dmtuid}?size={size}</code> — Get label as SVG (sizes: 50x30, 75x50, 100x50,
      4x6)</span></div>
  <p style="color:var(--text-dim); font-size:.85rem; margin-top:.75rem;">
    Labels include: MPN, Value, Package, DMTUID barcode, Location, Description. All text auto-adjusts for readability.
  </p>
</div>

<!-- Niimbot Printer -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>Niimbot Printer (BLE)</h2>
  <p style="color:var(--text-dim); font-size:.85rem; margin-bottom:.75rem;">
    Direct BLE integration for Niimbot B1 thermal label printers (203 DPI, 384px width).
  </p>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/labels/niimbot/scan</code> — Scan for nearby Niimbot printers</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/labels/niimbot/connect</code> — Connect to printer (JSON: address)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/labels/niimbot/disconnect</code> — Disconnect from printer</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/labels/niimbot/status</code> — Get current connection status</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/labels/niimbot/print</code> — Print single label (JSON: dmtuid, size, density)</span>
  </div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/labels/niimbot/batch</code> — Print multiple labels (JSON: dmtuids[], size,
      density)</span></div>
  <p style="color:var(--text-dim); font-size:.85rem; margin-top:.75rem;">
    Density values: 1 (lightest) to 5 (darkest). Requires <code>bleak</code> library for BLE communication.
  </p>
</div>

<!-- Library Management -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>Library Management</h2>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/libs</code> — List all library files (symbols, footprints, 3dmodels)</span>
  </div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/libs/download</code> — Download all libraries as ZIP</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/upload</code> — Upload library file (form: file, dmtuid, preview,
      symbol_props)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--red);">DELETE</span><span
      class="field-value"><code>/api/v1/libs/{type}/{filename}</code> — Delete library file</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/symbols/{filename}/sync</code> — Sync symbol properties from part</span>
  </div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/link</code> — Link existing library file to part</span></div>
</div>

<!-- Staging -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>File Staging</h2>
  <p style="color:var(--text-dim); font-size:.85rem; margin-bottom:.75rem;">
    Stage files temporarily before committing with a part.
  </p>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/stage/session</code> — Create staging session (returns session_id)</span>
  </div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/stage</code> — Stage a file (form: file, session_id)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/libs/stage/{session_id}</code> — Get staged files</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/stage/{session_id}/props</code> — Update staged symbol properties</span>
  </div>
  <div class="field-row"><span class="field-label" style="color:var(--red);">DELETE</span><span
      class="field-value"><code>/api/v1/libs/stage/{session_id}</code> — Clear staged files</span></div>
</div>

<!-- Client Sync -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>Client Sync</h2>
  <p style="color:var(--text-dim); font-size:.85rem; margin-bottom:.75rem;">
    Per-PC configuration for library paths and sync status. Client identified by IP.
  </p>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/libs/client</code> — Get client config for current IP</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/client</code> — Save client config (JSON: client_name, path_symbols,
      path_footprints, path_3dmodels)</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/libs/client/mark-synced</code> — Mark client as synced with current libs</span>
  </div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/libs/sync/status</code> — Check if sync needed, get file list</span></div>
  <div class="field-row"><span class="field-label" style="color:var(--green);">GET</span><span
      class="field-value"><code>/api/v1/libs/clients</code> — List all registered clients</span></div>
</div>

<!-- CSV Import -->
<div class="detail-card" style="margin-bottom:1rem;">
  <h2>CSV Import</h2>
  <div class="field-row"><span class="field-label" style="color:var(--yellow);">POST</span><span
      class="field-value"><code>/api/v1/import?replace=0|1</code> — Import CSV (multipart: csv_file, or raw body)</span>
  </div>
  <p style="color:var(--text-dim); font-size:.85rem; margin-top:.5rem;">
    Returns: <code>{"total_rows", "imported", "skipped", "errors": [{"row", "reason"}]}</code>
  </p>
</div>

<!-- cURL Examples -->
<div class="detail-card">
  <h2>cURL Examples</h2>
  <pre
    style="font-size:.8rem; color:var(--text-dim); overflow-x:auto; white-space:pre-wrap; background:var(--bg); padding:.75rem; border-radius:var(--radius);">
# Search parts (supports: q, tt, ff, sort, order, limit, offset)
curl "http://localhost:5000/api/v1/parts?q=MOSFET&limit=10&sort=created_at&order=desc"

# Get single part
curl "http://localhost:5000/api/v1/parts/DMT-02030110001"

# Create part
curl -X POST "http://localhost:5000/api/v1/parts" \
  -H "Content-Type: application/json" \
  -d '{"tt":"01","ff":"02","cc":"01","ss":"03","MPN":"RC0603FR-0710KL","Value":"10K"}'

# Update part
curl -X PUT "http://localhost:5000/api/v1/parts/DMT-01020103001" \
  -H "Content-Type: application/json" \
  -d '{"kicad_symbol":"Device:R","kicad_footprint":"Resistor_SMD:R_0603"}'

# Import CSV
curl -X POST "http://localhost:5000/api/v1/import" -F "csv_file=@parts.csv"

# List all library files
curl "http://localhost:5000/api/v1/libs"

# Download libraries as ZIP
curl -o DMTDB_libs.zip "http://localhost:5000/api/v1/libs/download"

# Upload symbol with preview
curl -X POST "http://localhost:5000/api/v1/libs/upload" \
  -F "file=@MySymbol.kicad_sym" -F "preview=true"

# KiCad HTTP Library (test from terminal)
curl "http://localhost:5000/kicad/v1/"
curl "http://localhost:5000/kicad/v1/categories.json"
curl "http://localhost:5000/kicad/v1/parts.json"

# Check client sync status
curl "http://localhost:5000/api/v1/libs/sync/status"

# KiCad search by MPN
curl "http://localhost:5000/api/v1/kicad/search?mpn=BSS138LT1G"

# Get label SVG (sizes: 50x30, 75x50, 100x50, 4x6)
curl "http://localhost:5000/labels/svg/DMT-01020103001?size=75x50" -o label.svg

# Scan for Niimbot printers
curl "http://localhost:5000/labels/niimbot/scan"

# Connect to Niimbot printer
curl -X POST "http://localhost:5000/labels/niimbot/connect" \
  -H "Content-Type: application/json" \
  -d '{"address":"AA:BB:CC:DD:EE:FF"}'

# Print single label on Niimbot
curl -X POST "http://localhost:5000/labels/niimbot/print" \
  -H "Content-Type: application/json" \
  -d '{"dmtuid":"DMT-01020103001","size":"50x30","density":3}'

# Batch print on Niimbot
curl -X POST "http://localhost:5000/labels/niimbot/batch" \
  -H "Content-Type: application/json" \
  -d '{"dmtuids":["DMT-01020103001","DMT-01020103002"],"size":"50x30","density":3}'
  </pre>
</div>
{% endblock %}