{% extends "base.html" %}
{% block title %}DMTDB - Browse Parts{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Parts Library</h1>
    <span class="subtitle">{{ total }} part{{ 's' if total != 1 }} found</span>
  </div>
  <a href="/part/add" class="btn btn-primary">+ Add Part</a>
</div>

<form method="get" action="/" id="searchForm">
  <div class="search-box">
    <div class="search-wrapper" id="searchWrapper">
      <input type="text" name="q" id="searchInput" value="{{ q }}"
        placeholder="Search DMTUID, MPN, value, manufacturer, description…" autocomplete="off">
      <div class="search-dropdown" id="searchDropdown"></div>
    </div>
    <select name="tt" id="ttSelect">
      <option value="">All Domains</option>
      {% for dom in domains %}
      <option value="{{ dom.tt }}" {% if tt==dom.tt %}selected{% endif %}>{{ dom.tt }} - {{ dom.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-secondary">Search</button>
    <button type="button" class="btn btn-secondary" id="advSearchToggle">▼ Advanced</button>
  </div>

  <!-- Advanced Search Panel (collapsed by default) -->
  <div class="adv-search-panel" id="advSearchPanel">
    <div class="adv-search-grid">
      <div class="adv-filter-group">
        <label>Domain (TT)</label>
        <select name="tt_adv" id="ttAdvSelect">
          <option value="">All Domains</option>
          {% for dom in domains %}
          <option value="{{ dom.tt }}" {% if tt==dom.tt %}selected{% endif %}>{{ dom.tt }} - {{ dom.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="adv-filter-group">
        <label>Family (FF)</label>
        <select name="ff" id="ffSelect">
          <option value="">All Families</option>
        </select>
      </div>
      <div class="adv-filter-group">
        <label>Class (CC)</label>
        <select name="cc" id="ccSelect">
          <option value="">All Classes</option>
        </select>
      </div>
      <div class="adv-filter-group">
        <label>Style (SS)</label>
        <select name="ss" id="ssSelect">
          <option value="">All Styles</option>
        </select>
      </div>
    </div>
    <div class="adv-props-section" id="advPropsSection">
      <div class="adv-props-header">
        <span>Property Filters</span>
        <span class="facet-count" id="facetCount"></span>
      </div>
      <div class="facet-grid" id="facetGrid">
        <!-- DigiKey-style faceted filters loaded dynamically -->
        <div class="facet-loading" id="facetLoading">Select a Domain and Family to see available filters</div>
      </div>
    </div>
    <div class="adv-search-actions">
      <button type="submit" class="btn btn-primary">Apply Filters</button>
      <button type="button" class="btn btn-secondary" id="clearFilters">Clear All</button>
    </div>
  </div>

  <!-- Hidden inputs for property filters -->
  <input type="hidden" name="props" id="propsInput" value="{{ props|default('') }}">
</form>

<script>
  window.domainsData = {{ domains | tojson | safe }};
  window.currentFilters = {
    tt: "{{ tt }}",
    ff: "{{ ff }}",
    cc: "{{ cc|default('') }}",
    ss: "{{ ss|default('') }}",
    props: {{ props_parsed |default ({}) | tojson | safe }}
  };
  console.log("Domains loaded:", window.domainsData.length, window.domainsData);
</script>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        {% macro sort_header(label, col) %}
        {% set new_order = 'desc' if sort_by == col and sort_order == 'asc' else 'asc' %}
        <th class="sortable {% if sort_by == col %}sorted {{ sort_order }}{% endif %}">
          <a
            href="?q={{ q }}&tt={{ tt }}&ff={{ ff }}&cc={{ cc|default('') }}&ss={{ ss|default('') }}&props={{ props|default('') }}&sort={{ col }}&order={{ new_order }}">
            {{ label }}
            <span class="sort-indicator"></span>
          </a>
        </th>
        {% endmacro %}
        {{ sort_header('DMTUID', 'dmtuid') }}
        {{ sort_header('MPN', 'mpn') }}
        {{ sort_header('Value', 'value') }}
        {{ sort_header('Qty', 'quantity') }}
        {{ sort_header('Location', 'location') }}
        <th>Domain / Family</th>
        {{ sort_header('Manufacturer', 'manufacturer') }}
        <th class="truncate">Description</th>
        <th title="KiCad Assets">KiCad</th>
        <th title="Datasheet">DS</th>
      </tr>
    </thead>
    <tbody>
      {% for p in parts %}
      <tr>
        <td class="uid-cell"><a href="/part/{{ p.dmtuid }}">{{ p.dmtuid }}</a></td>
        <td>{{ p.mpn or '' }}</td>
        <td>{{ p.value or '' }}</td>
        <td>{{ p.quantity or '' }}</td>
        <td>{{ p.location or '' }}</td>
        <td>
          <span class="badge badge-domain">{{ p.tt }}</span>
          <span class="badge badge-family">{{ p.ff }}</span>
          <span style="font-size:.8rem; color:var(--text-dim)">{{ family_name(p.tt, p.ff) }}</span>
        </td>
        <td>{{ p.manufacturer or '' }}</td>
        <td class="truncate" title="{{ p.description or '' }}">{{ p.description or '' }}</td>
        <td class="kicad-icons">
          <span class="kicad-icon {% if p.kicad_symbol %}available{% else %}unavailable{% endif %}"
            title="Symbol: {{ p.kicad_symbol or 'Not available' }}">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="4,4 4,20 20,12" />
              <line x1="1" y1="8" x2="4" y2="8" />
              <line x1="1" y1="16" x2="4" y2="16" />
              <line x1="20" y1="12" x2="23" y2="12" />
            </svg>
          </span>
          <span class="kicad-icon {% if p.kicad_footprint %}available{% else %}unavailable{% endif %}"
            title="Footprint: {{ p.kicad_footprint or 'Not available' }}">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="3" width="12" height="18" rx="1" />
              <line x1="2" y1="6" x2="6" y2="6" />
              <line x1="2" y1="10" x2="6" y2="10" />
              <line x1="2" y1="14" x2="6" y2="14" />
              <line x1="2" y1="18" x2="6" y2="18" />
              <line x1="18" y1="6" x2="22" y2="6" />
              <line x1="18" y1="10" x2="22" y2="10" />
              <line x1="18" y1="14" x2="22" y2="14" />
              <line x1="18" y1="18" x2="22" y2="18" />
            </svg>
          </span>
          <span class="kicad-icon {% if p.kicad_3dmodel %}available{% else %}unavailable{% endif %}"
            title="3D Model: {{ p.kicad_3dmodel or 'Not available' }}">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="4,8 4,20 12,24 12,12" />
              <polygon points="4,8 12,4 20,8 12,12" />
              <polygon points="12,12 20,8 20,20 12,24" />
            </svg>
          </span>
        </td>
        <td class="ds-icon">
          {% if p.datasheet %}
          {% if p.datasheet.startswith('http') %}
          <a href="{{ p.datasheet }}" target="_blank" rel="noopener" title="Open datasheet">Datasheet</a>
          {% else %}
          <a href="/datasheets/{{ p.datasheet }}" target="_blank" rel="noopener" title="Open datasheet">Datasheet</a>
          {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if not parts %}
      <tr>
        <td colspan="10" style="text-align:center; padding:2rem; color:var(--text-dim);">No parts found.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if total_pages > 1 %}
<div class="pager">
  {% if page > 1 %}
  <a
    href="?q={{ q }}&tt={{ tt }}&ff={{ ff }}&cc={{ cc|default('') }}&ss={{ ss|default('') }}&props={{ props|default('') }}&sort={{ sort_by }}&order={{ sort_order }}&page={{ page - 1 }}">←
    Prev</a>
  {% endif %}
  {% for p in range(1, total_pages + 1) %}
  {% if p == page %}
  <span class="current">{{ p }}</span>
  {% elif p <= 3 or p>= total_pages - 2 or (p >= page - 2 and p <= page + 2) %} <a
      href="?q={{ q }}&tt={{ tt }}&ff={{ ff }}&cc={{ cc|default('') }}&ss={{ ss|default('') }}&props={{ props|default('') }}&sort={{ sort_by }}&order={{ sort_order }}&page={{ p }}">
      {{ p }}</a>
      {% elif p == 4 or p == total_pages - 3 %}
      <span class="info">…</span>
      {% endif %}
      {% endfor %}
      {% if page < total_pages %} <a
        href="?q={{ q }}&tt={{ tt }}&ff={{ ff }}&cc={{ cc|default('') }}&ss={{ ss|default('') }}&props={{ props|default('') }}&sort={{ sort_by }}&order={{ sort_order }}&page={{ page + 1 }}">
        Next →</a>
        {% endif %}
        <span class="info">({{ total }} total)</span>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="/static/js/search.js"></script>
<script src="/static/js/adv_search.js"></script>
{% endblock %}