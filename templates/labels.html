{% extends "base.html" %}
{% block title %}Label Printing - DMTDB{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Label Printing</h1>
    <span class="subtitle">Click a part to generate label</span>
</div>

<!-- Controls Bar -->
<div class="detail-card" style="margin-bottom: 1rem;">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <input type="text" id="searchInput" placeholder="Search parts..."
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg);">
        </div>
        <div>
            <select id="ttSelect"
                style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg);">
                <option value="">All Domains</option>
                {% for d in domains %}
                <option value="{{ d.tt }}">{{ d.tt }} - {{ d.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="button" id="advSearchToggle" class="btn btn-secondary" style="font-size: 0.85rem;">▼
                Advanced</button>
        </div>
        <div>
            <select id="pageSizeSelect" onchange="changePageSize(this.value)"
                style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg);">
                <option value="25">25/page</option>
                <option value="50">50/page</option>
                <option value="100" selected>100/page</option>
                <option value="200">200/page</option>
                <option value="500">500/page</option>
            </select>
        </div>
        <div>
            <label style="margin-right: 0.5rem;">Size:</label>
            <select id="labelSize"
                style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg);">
                {% for key, (w, h, name) in sizes.items() %}
                <option value="{{ key }}" {% if key=='50x30' %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button id="batchPrintBtn" class="btn" onclick="batchPrint()" disabled>
                Print Selected (<span id="selectedCount">0</span>)
            </button>
        </div>
        <div>
            <button id="batchNiimbotBtn" class="btn" onclick="batchPrintNiimbot()" disabled
                title="Print selected labels to Niimbot B1">
                <span id="batchNiimbotStatus"
                    style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #666; margin-right: 0.3rem;"></span>
                Niimbot (<span id="selectedCountNiimbot">0</span>)
            </button>
        </div>
    </div>

    <!-- Advanced Search Panel -->
    <div class="adv-search-panel" id="advSearchPanel">
        <div class="adv-search-grid">
            <div class="adv-filter-group">
                <label>Domain (TT)</label>
                <select id="ttAdvSelect">
                    <option value="">All Domains</option>
                    {% for d in domains %}
                    <option value="{{ d.tt }}">{{ d.tt }} - {{ d.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="adv-filter-group">
                <label>Family (FF)</label>
                <select id="ffSelect">
                    <option value="">All Families</option>
                </select>
            </div>
            <div class="adv-filter-group">
                <label>Class (CC)</label>
                <select id="ccSelect">
                    <option value="">All Classes</option>
                </select>
            </div>
            <div class="adv-filter-group">
                <label>Style (SS)</label>
                <select id="ssSelect">
                    <option value="">All Styles</option>
                </select>
            </div>
        </div>
        <div class="adv-props-section">
            <div class="adv-props-header">
                <span>Property Filters</span>
                <span class="facet-count" id="facetCount"></span>
            </div>
            <div class="facet-grid" id="facetGrid">
                <div class="facet-loading">Select a Domain and Family to see available filters</div>
            </div>
        </div>
        <div class="adv-search-actions">
            <button type="button" class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
            <button type="button" class="btn btn-secondary" id="clearFilters">Clear All</button>
        </div>
    </div>
</div>

<!-- Parts List -->
<div class="detail-card">
    <table class="parts-table" style="width: 100%;">
        <thead>
            <tr>
                <th style="width: 30px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                <th class="sortable" data-sort="dmtuid" onclick="toggleSort('dmtuid')">DMTUID <span
                        class="sort-indicator"></span></th>
                <th class="sortable" data-sort="mpn" onclick="toggleSort('mpn')">MPN <span
                        class="sort-indicator"></span></th>
                <th class="sortable" data-sort="value" onclick="toggleSort('value')">Value <span
                        class="sort-indicator"></span></th>
                <th class="sortable" data-sort="manufacturer" onclick="toggleSort('manufacturer')">Manufacturer <span
                        class="sort-indicator"></span></th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody id="partsBody">
            <tr>
                <td colspan="6" style="text-align: center; color: var(--text-dim);">Loading...</td>
            </tr>
        </tbody>
    </table>

    <!-- Pagination -->
    <div id="pagination"
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <span id="pageInfo">-</span>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn" onclick="prevPage()" id="prevBtn" disabled>← Prev</button>
            <button class="btn" onclick="nextPage()" id="nextBtn" disabled>Next →</button>
        </div>
    </div>
</div>

<!-- Label Modal -->
<div id="labelModal" class="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Label Preview</h2>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
            <div id="modalPartInfo" style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-dim);"></div>
            <div id="labelPreview"
                style="background: white; padding: 2rem; border-radius: var(--radius); display: flex; justify-content: center; align-items: center; min-height: 200px;">
                Loading...
            </div>
        </div>
        <div class="modal-footer" style="flex-wrap: wrap; gap: 0.5rem;">
            <select id="modalSize" onchange="refreshModalPreview()"
                style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius);">
                {% for key, (w, h, name) in sizes.items() %}
                <option value="{{ key }}" {% if key=='50x30' %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
            <button class="btn" onclick="downloadCurrentLabel()">Download SVG</button>
            <button class="btn btn-primary" onclick="printCurrentLabel()">Print</button>
            <div style="border-left: 1px solid var(--border); height: 30px; margin: 0 0.5rem;"></div>
            <button class="btn btn-primary" id="niimbotPrintBtn" onclick="printToNiimbot()" disabled>
                <span id="niimbotModalStatus"
                    style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #666; margin-right: 0.5rem;"></span>
                Print to Niimbot
            </button>
        </div>
    </div>
</div>

<!-- Hidden print frame -->
<iframe id="printFrame" style="display: none;"></iframe>

<style>
    .parts-table {
        border-collapse: collapse;
    }

    .parts-table th,
    .parts-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .parts-table th {
        font-weight: 600;
        color: var(--text-dim);
        font-size: 0.85rem;
    }

    .parts-table th.sortable {
        cursor: pointer;
        user-select: none;
    }

    .parts-table th.sortable:hover {
        color: var(--text);
        background: var(--bg);
    }

    .parts-table th.sortable .sort-indicator::after {
        content: '';
        margin-left: 0.3rem;
        opacity: 0.3;
    }

    .parts-table th.sortable.sorted .sort-indicator::after {
        opacity: 1;
    }

    .parts-table th.sortable.sorted.asc .sort-indicator::after {
        content: '▲';
    }

    .parts-table th.sortable.sorted.desc .sort-indicator::after {
        content: '▼';
    }

    .parts-table tbody tr:hover {
        background: var(--bg);
    }

    .dmtuid-link {
        font-family: monospace;
        font-size: 0.85rem;
        color: var(--accent);
        text-decoration: none;
        cursor: pointer;
    }

    .dmtuid-link:hover {
        text-decoration: underline;
    }

    /* Label preview - scaling applied via JS */
    #labelPreview {
        overflow: visible;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
    }

    #labelPreview svg {
        display: block;
        transform-origin: center center;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--surface);
        border-radius: var(--radius);
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.1rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-dim);
        line-height: 1;
    }

    .modal-close:hover {
        color: var(--text);
    }

    .modal-body {
        padding: 1rem;
    }

    .modal-footer {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        padding: 1rem;
        border-top: 1px solid var(--border);
    }

    @media print {
        body * {
            visibility: hidden;
        }

        #printFrame {
            visibility: visible;
            position: absolute;
            left: 0;
            top: 0;
        }
    }

    /* Spinner for loading states */
    .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    // Domains data for filter dropdowns
    window.domainsData = {{ domains | tojson | safe }};

    let parts = [];
    let selectedParts = new Set();
    let currentPage = 0;
    let totalParts = 0;
    let pageSize = 100;
    let currentModalDmtuid = null;
    let searchTimeout = null;
    let selectedProps = {}; // {fieldName: [value1, value2, ...]}
    let sortBy = 'dmtuid';
    let sortOrder = 'asc';

    // Load parts on page load
    document.addEventListener('DOMContentLoaded', function () {
        initAdvancedSearch();
        loadParts();
    });

    // Search input handler
    document.getElementById('searchInput').addEventListener('input', function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 0;
            loadParts();
        }, 300);
    });

    // ─── Advanced Search Functions ─────────────────────────────────────────
    function initAdvancedSearch() {
        const toggle = document.getElementById('advSearchToggle');
        const panel = document.getElementById('advSearchPanel');
        const ttSelect = document.getElementById('ttSelect');
        const ttAdvSelect = document.getElementById('ttAdvSelect');
        const ffSelect = document.getElementById('ffSelect');
        const ccSelect = document.getElementById('ccSelect');
        const ssSelect = document.getElementById('ssSelect');
        const clearBtn = document.getElementById('clearFilters');
        const applyBtn = document.getElementById('applyFiltersBtn');

        // Toggle panel visibility
        toggle.addEventListener('click', function () {
            panel.classList.toggle('show');
            const isOpen = panel.classList.contains('show');
            toggle.textContent = isOpen ? '▲ Advanced' : '▼ Advanced';

            // Hide/show main TT dropdown
            ttSelect.style.display = isOpen ? 'none' : '';

            // Sync and load on open
            if (isOpen) {
                ttAdvSelect.value = ttSelect.value;
                if (ttAdvSelect.value) {
                    populateFamilies(ttAdvSelect.value);
                    loadFacets();
                }
            }
        });

        // TT change (advanced panel)
        ttAdvSelect.addEventListener('change', function () {
            ttSelect.value = ttAdvSelect.value;
            populateFamilies(ttAdvSelect.value);
            clearCCSS();
            clearFacets();
            if (ttAdvSelect.value) {
                loadFacets();
            }
            currentPage = 0;
            loadParts();
        });

        // TT change (main dropdown)
        ttSelect.addEventListener('change', function () {
            ttAdvSelect.value = ttSelect.value;
            populateFamilies(ttSelect.value);
            clearCCSS();
            clearFacets();
            currentPage = 0;
            loadParts();
        });

        // FF change
        ffSelect.addEventListener('change', function () {
            const tt = ttAdvSelect.value || ttSelect.value;
            if (tt && ffSelect.value) {
                loadCCSS(tt, ffSelect.value);
            } else {
                clearCCSS();
            }
            loadFacets();
            currentPage = 0;
            loadParts();
        });

        // CC/SS change
        ccSelect.addEventListener('change', function () {
            loadFacets();
            currentPage = 0;
            loadParts();
        });
        ssSelect.addEventListener('change', function () {
            loadFacets();
            currentPage = 0;
            loadParts();
        });

        // Clear all filters
        clearBtn.addEventListener('click', function () {
            ttSelect.value = '';
            ttAdvSelect.value = '';
            ffSelect.innerHTML = '<option value="">All Families</option>';
            clearCCSS();
            clearFacets();
            selectedProps = {};
            currentPage = 0;
            loadParts();
        });

        // Apply filters button
        applyBtn.addEventListener('click', function () {
            currentPage = 0;
            loadParts();
        });
    }

    function populateFamilies(tt) {
        const ffSelect = document.getElementById('ffSelect');
        ffSelect.innerHTML = '<option value="">All Families</option>';
        const domains = window.domainsData || [];
        const dom = domains.find(d => d.tt === tt);
        if (dom && dom.families) {
            dom.families.forEach(f => {
                const o = document.createElement('option');
                o.value = f.ff;
                o.textContent = f.ff + ' - ' + f.name;
                ffSelect.appendChild(o);
            });
        }
    }

    function clearCCSS() {
        document.getElementById('ccSelect').innerHTML = '<option value="">All Classes</option>';
        document.getElementById('ssSelect').innerHTML = '<option value="">All Styles</option>';
    }

    function clearFacets() {
        selectedProps = {};
        const facetGrid = document.getElementById('facetGrid');
        facetGrid.innerHTML = '<div class="facet-loading">Select a Domain and Family to see available filters</div>';
        document.getElementById('facetCount').textContent = '';
    }

    async function loadCCSS(tt, ff) {
        try {
            const resp = await fetch('/ui-api/template_fields?tt=' + tt + '&ff=' + ff);
            const data = await resp.json();

            // Populate CC
            const ccSelect = document.getElementById('ccSelect');
            ccSelect.innerHTML = '<option value="">All Classes</option>';
            if (data.guidelines && data.guidelines.cc) {
                Object.entries(data.guidelines.cc).forEach(([key, val]) => {
                    const o = document.createElement('option');
                    o.value = key.toString().padStart(2, '0');
                    o.textContent = key.toString().padStart(2, '0') + ' - ' + val;
                    ccSelect.appendChild(o);
                });
            }

            // Populate SS
            const ssSelect = document.getElementById('ssSelect');
            ssSelect.innerHTML = '<option value="">All Styles</option>';
            if (data.guidelines && data.guidelines.ss) {
                Object.entries(data.guidelines.ss).forEach(([key, val]) => {
                    const o = document.createElement('option');
                    o.value = key.toString().padStart(2, '0');
                    o.textContent = key.toString().padStart(2, '0') + ' - ' + val;
                    ssSelect.appendChild(o);
                });
            }
        } catch (err) {
            console.error('Error loading CC/SS:', err);
        }
    }

    async function loadFacets() {
        const tt = document.getElementById('ttAdvSelect').value || document.getElementById('ttSelect').value;
        const ff = document.getElementById('ffSelect').value;
        const cc = document.getElementById('ccSelect').value;
        const ss = document.getElementById('ssSelect').value;
        const facetGrid = document.getElementById('facetGrid');
        const facetCount = document.getElementById('facetCount');

        if (!tt) {
            facetGrid.innerHTML = '<div class="facet-loading">Select a Domain to see available filters</div>';
            facetCount.textContent = '';
            return;
        }

        facetGrid.innerHTML = '<div class="facet-loading">Loading filters...</div>';

        try {
            let url = '/ui-api/facets?tt=' + encodeURIComponent(tt);
            if (ff) url += '&ff=' + encodeURIComponent(ff);
            if (cc) url += '&cc=' + encodeURIComponent(cc);
            if (ss) url += '&ss=' + encodeURIComponent(ss);

            const resp = await fetch(url);
            const data = await resp.json();

            // facets is an object {fieldName: [{value, count}, ...]}
            const facetKeys = Object.keys(data.facets || {});

            if (facetKeys.length === 0) {
                facetGrid.innerHTML = '<div class="facet-loading">No property filters available</div>';
                facetCount.textContent = '';
                return;
            }

            facetCount.textContent = data.total + ' parts match';
            facetGrid.innerHTML = '';

            facetKeys.forEach(fieldName => {
                const values = data.facets[fieldName];
                if (!values || values.length === 0) return;

                const card = document.createElement('div');
                card.className = 'facet-box';

                const header = document.createElement('div');
                header.className = 'facet-header';
                header.innerHTML = '<span class="facet-name">' + escapeHtml(fieldName) + '</span>';
                card.appendChild(header);

                const list = document.createElement('div');
                list.className = 'facet-list';

                values.forEach(v => {
                    const label = document.createElement('label');
                    label.className = 'facet-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.field = fieldName;
                    checkbox.dataset.value = v.value;
                    checkbox.checked = (selectedProps[fieldName] || []).includes(v.value);
                    checkbox.addEventListener('change', function () {
                        if (this.checked) {
                            if (!selectedProps[fieldName]) selectedProps[fieldName] = [];
                            selectedProps[fieldName].push(v.value);
                        } else {
                            selectedProps[fieldName] = (selectedProps[fieldName] || []).filter(x => x !== v.value);
                            if (selectedProps[fieldName].length === 0) delete selectedProps[fieldName];
                        }
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + v.value + ' '));

                    const count = document.createElement('span');
                    count.className = 'facet-count';
                    count.textContent = '(' + v.count + ')';
                    label.appendChild(count);

                    list.appendChild(label);
                });

                card.appendChild(list);
                facetGrid.appendChild(card);
            });
        } catch (err) {
            console.error('Error loading facets:', err);
            facetGrid.innerHTML = '<div class="facet-loading">Error loading filters</div>';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ─── Parts Loading ─────────────────────────────────────────────────────
    async function loadParts() {
        const query = document.getElementById('searchInput').value.trim();
        const tt = document.getElementById('ttAdvSelect').value || document.getElementById('ttSelect').value;
        const ff = document.getElementById('ffSelect').value;
        const cc = document.getElementById('ccSelect').value;
        const ss = document.getElementById('ssSelect').value;
        const offset = currentPage * pageSize;

        try {
            let url = `/api/v1/parts?limit=${pageSize}&offset=${offset}`;
            if (query) url += '&q=' + encodeURIComponent(query);
            if (tt) url += '&tt=' + encodeURIComponent(tt);
            if (ff) url += '&ff=' + encodeURIComponent(ff);
            if (cc) url += '&cc=' + encodeURIComponent(cc);
            if (ss) url += '&ss=' + encodeURIComponent(ss);
            if (Object.keys(selectedProps).length > 0) {
                url += '&props=' + encodeURIComponent(JSON.stringify(selectedProps));
            }
            url += '&sort=' + encodeURIComponent(sortBy);
            url += '&order=' + encodeURIComponent(sortOrder);

            const resp = await fetch(url);
            const data = await resp.json();

            parts = data.parts || [];
            totalParts = data.total || 0;

            renderParts();
            updatePagination();
        } catch (err) {
            console.error('Load error:', err);
            document.getElementById('partsBody').innerHTML =
                '<tr><td colspan="7" style="text-align:center;color:var(--red);">Error loading parts</td></tr>';
        }
    }

    function renderParts() {
        const tbody = document.getElementById('partsBody');

        if (parts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No parts found</td></tr>';
            return;
        }

        tbody.innerHTML = parts.map(p => `
    <tr>
      <td><input type="checkbox" class="part-check" data-dmtuid="${p.dmtuid}" 
                 ${selectedParts.has(p.dmtuid) ? 'checked' : ''} onchange="togglePart('${p.dmtuid}')"></td>
      <td><a href="#" class="dmtuid-link" onclick="openLabelModal('${p.dmtuid}');return false;">${p.dmtuid}</a></td>
      <td>${p.mpn || '-'}</td>
      <td>${p.value || '-'}</td>
      <td>${p.manufacturer || '-'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${p.description || ''}">${p.description || '-'}</td>
    </tr>
  `).join('');
    }

    function updatePagination() {
        const start = currentPage * pageSize + 1;
        const end = Math.min(start + parts.length - 1, totalParts);
        document.getElementById('pageInfo').textContent = totalParts > 0 ? `${start}-${end} of ${totalParts}` : 'No parts';
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = end >= totalParts;
        updateSortIndicators();
    }

    function toggleSort(column) {
        if (sortBy === column) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            sortBy = column;
            sortOrder = 'asc';
        }
        currentPage = 0;
        loadParts();
    }

    function updateSortIndicators() {
        document.querySelectorAll('.parts-table th.sortable').forEach(th => {
            th.classList.remove('sorted', 'asc', 'desc');
            if (th.dataset.sort === sortBy) {
                th.classList.add('sorted', sortOrder);
            }
        });
    }

    function changePageSize(newSize) {
        pageSize = parseInt(newSize);
        currentPage = 0;
        loadParts();
    }

    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            loadParts();
        }
    }

    function nextPage() {
        if ((currentPage + 1) * pageSize < totalParts) {
            currentPage++;
            loadParts();
        }
    }

    function togglePart(dmtuid) {
        if (selectedParts.has(dmtuid)) {
            selectedParts.delete(dmtuid);
        } else {
            selectedParts.add(dmtuid);
        }
        updateSelectedCount();
    }

    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.part-check').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedParts.add(cb.dataset.dmtuid);
            } else {
                selectedParts.delete(cb.dataset.dmtuid);
            }
        });
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = selectedParts.size;
        const countEl = document.getElementById('selectedCount');
        const countNiimbotEl = document.getElementById('selectedCountNiimbot');
        const batchPrintBtn = document.getElementById('batchPrintBtn');
        const batchNiimbotBtn = document.getElementById('batchNiimbotBtn');

        if (countEl) countEl.textContent = count;
        if (countNiimbotEl) countNiimbotEl.textContent = count;
        if (batchPrintBtn) batchPrintBtn.disabled = count === 0;
        // Batch Niimbot button enabled if connected AND parts selected
        if (batchNiimbotBtn) batchNiimbotBtn.disabled = !window.niimbotConnected || count === 0;
    }

    // Modal functions
    async function openLabelModal(dmtuid) {
        currentModalDmtuid = dmtuid;

        // Find part info
        const part = parts.find(p => p.dmtuid === dmtuid);
        document.getElementById('modalTitle').textContent = dmtuid;
        document.getElementById('modalPartInfo').textContent = part ?
            `${part.mpn || ''} · ${part.manufacturer || ''} · ${part.value || ''}` : '';

        // Sync size selector
        document.getElementById('modalSize').value = document.getElementById('labelSize').value;

        // Show modal
        document.getElementById('labelModal').classList.add('active');

        // Load preview
        await refreshModalPreview();
    }

    // Label dimensions in mm for smart scaling
    const LABEL_DIMS = {
        '50x30': { w: 50, h: 30 },
        '75x50': { w: 75, h: 50 },
        '100x50': { w: 100, h: 50 },
        '4x6': { w: 101.6, h: 152.4 }
    };

    async function refreshModalPreview() {
        if (!currentModalDmtuid) return;

        const size = document.getElementById('modalSize').value;
        const preview = document.getElementById('labelPreview');
        preview.innerHTML = '<span style="color:var(--text-dim);">Loading...</span>';

        try {
            const resp = await fetch(`/labels/preview?dmtuid=${encodeURIComponent(currentModalDmtuid)}&size=${size}`);
            if (resp.ok) {
                preview.innerHTML = await resp.text();

                // Smart scale based on label size and viewport
                const svg = preview.querySelector('svg');
                if (svg) {
                    const dims = LABEL_DIMS[size] || { w: 50, h: 30 };

                    // Available space (80% of viewport, max 800px wide)
                    const maxW = Math.min(window.innerWidth * 0.75, 800);
                    const maxH = window.innerHeight * 0.6;

                    // Convert mm to approximate pixels (3.78 px/mm at 96dpi)
                    const labelPxW = dims.w * 3.78;
                    const labelPxH = dims.h * 3.78;

                    // Calculate scale to fit with some padding
                    const scaleW = maxW / labelPxW;
                    const scaleH = maxH / labelPxH;
                    const scale = Math.min(scaleW, scaleH, 3); // Cap at 3x for small labels

                    svg.style.transform = `scale(${scale.toFixed(2)})`;

                    // Adjust container to accommodate scaled SVG while keeping centered
                    preview.style.minWidth = (labelPxW * scale + 40) + 'px';
                    preview.style.minHeight = (labelPxH * scale + 40) + 'px';
                }
            } else {
                preview.innerHTML = '<span style="color:var(--red);">Error loading label</span>';
            }
        } catch (err) {
            preview.innerHTML = '<span style="color:var(--red);">Error: ' + err.message + '</span>';
        }
    }

    function closeModal() {
        document.getElementById('labelModal').classList.remove('active');
        currentModalDmtuid = null;
    }

    function downloadCurrentLabel() {
        if (!currentModalDmtuid) return;
        const size = document.getElementById('modalSize').value;
        window.location.href = `/labels/download?dmtuid=${encodeURIComponent(currentModalDmtuid)}&size=${size}`;
    }

    function printCurrentLabel() {
        if (!currentModalDmtuid) return;
        const size = document.getElementById('modalSize').value;

        // Open in new window for printing (with print=1 to omit preview frame)
        const printWin = window.open(`/labels/preview?dmtuid=${encodeURIComponent(currentModalDmtuid)}&size=${size}&print=1`, '_blank', 'width=600,height=400');
        printWin.onload = function () {
            printWin.print();
        };
    }

    async function batchPrint() {
        if (selectedParts.size === 0) return;

        const size = document.getElementById('labelSize').value;
        const dmtuids = Array.from(selectedParts);

        // Fetch all labels and combine into one page (with print=1 to omit preview frame)
        const labels = [];
        for (const dmtuid of dmtuids) {
            try {
                const resp = await fetch(`/labels/preview?dmtuid=${encodeURIComponent(dmtuid)}&size=${size}&print=1`);
                if (resp.ok) {
                    labels.push(await resp.text());
                }
            } catch (err) {
                console.error('Error fetching label:', dmtuid, err);
            }
        }

        if (labels.length === 0) {
            alert('No labels to print');
            return;
        }

        // Create print document
        const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Batch Labels</title>
      <style>
        @page { margin: 5mm; }
        body { margin: 0; padding: 0; }
        .label { page-break-inside: avoid; margin-bottom: 5mm; }
      </style>
    </head>
    <body>
      ${labels.map(l => '<div class="label">' + l + '</div>').join('')}
    </body>
    </html>
  `;

        const printWin = window.open('', '_blank', 'width=800,height=600');
        printWin.document.write(printContent);
        printWin.document.close();
        printWin.onload = function () {
            printWin.print();
        };
    }

    // ESC to close modal
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // ─── Niimbot B1 Integration (uses global state from base.html) ─────────
    // Update local Niimbot UI elements when global state changes
    function updateLocalNiimbotUI() {
        const modalStatusDot = document.getElementById('niimbotModalStatus');
        const batchStatusDot = document.getElementById('batchNiimbotStatus');
        const printBtn = document.getElementById('niimbotPrintBtn');
        const batchBtn = document.getElementById('batchNiimbotBtn');

        const connected = window.niimbotConnected || false;

        if (connected) {
            if (modalStatusDot) modalStatusDot.style.background = '#4CAF50';
            if (batchStatusDot) batchStatusDot.style.background = '#4CAF50';
            if (printBtn) printBtn.disabled = false;
            if (batchBtn) batchBtn.disabled = selectedParts.size === 0;
        } else {
            if (modalStatusDot) modalStatusDot.style.background = '#666';
            if (batchStatusDot) batchStatusDot.style.background = '#666';
            if (printBtn) printBtn.disabled = true;
            if (batchBtn) batchBtn.disabled = true;
        }
    }

    // Listen for global Niimbot state changes
    window.addEventListener('niimbotStateChanged', updateLocalNiimbotUI);

    async function printToNiimbot() {
        if (!currentModalDmtuid) return;
        if (!window.niimbotConnected) {
            alert('Not connected to Niimbot printer. Use the Niimbot button in the top bar to connect.');
            return;
        }

        const printBtn = document.getElementById('niimbotPrintBtn');
        const size = document.getElementById('modalSize').value;
        const densityEl = document.getElementById('niimbotGlobalDensity');
        const density = densityEl ? parseInt(densityEl.value) : 3;

        printBtn.disabled = true;
        const originalHtml = printBtn.innerHTML;
        printBtn.innerHTML = '<span class="spinner"></span> Printing...';

        try {
            const resp = await fetch('/labels/niimbot/print', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dmtuid: currentModalDmtuid,
                    size: size,
                    density: density,
                    address: window.niimbotAddress
                })
            });
            const data = await resp.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // Brief success feedback
            printBtn.innerHTML = '<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; margin-right: 0.5rem;"></span> Printed!';
            setTimeout(() => {
                printBtn.innerHTML = originalHtml;
                printBtn.disabled = false;
            }, 1500);

        } catch (err) {
            alert('Print failed: ' + err.message);
            printBtn.innerHTML = originalHtml;
            printBtn.disabled = false;
        }
    }

    async function batchPrintNiimbot() {
        if (selectedParts.size === 0) {
            alert('No parts selected');
            return;
        }
        if (!window.niimbotConnected) {
            alert('Not connected to Niimbot printer. Use the Niimbot button in the top bar to connect.');
            return;
        }

        const batchBtn = document.getElementById('batchNiimbotBtn');
        const size = document.getElementById('labelSize').value;
        const densityEl = document.getElementById('niimbotGlobalDensity');
        const density = densityEl ? parseInt(densityEl.value) : 3;
        const dmtuids = Array.from(selectedParts);

        const originalText = batchBtn.innerHTML;
        batchBtn.disabled = true;
        batchBtn.innerHTML = `<span class="spinner"></span> Printing 0/${dmtuids.length}...`;

        try {
            const resp = await fetch('/labels/niimbot/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dmtuids: dmtuids,
                    size: size,
                    density: density
                })
            });
            const data = await resp.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // Show results
            const msg = `Printed ${data.printed} labels` +
                (data.failed > 0 ? `, ${data.failed} failed` : '');
            alert(msg);

            // Clear selection after successful batch
            if (data.printed > 0) {
                selectedParts.clear();
                updateSelectedCount();
                loadParts(); // Refresh to uncheck boxes
            }

        } catch (err) {
            alert('Batch print failed: ' + err.message);
        } finally {
            if (batchBtn) {
                batchBtn.innerHTML = originalText;
                batchBtn.disabled = selectedParts.size === 0 || !window.niimbotConnected;
            }
        }
    }

    // Initialize local Niimbot UI on page load
    document.addEventListener('DOMContentLoaded', updateLocalNiimbotUI);
</script>
{% endblock %}