{% extends "base.html" %}
{% block title %}KiCad Libraries - DMTDB{% endblock %}

{% block content %}
<div class="page-header">
    <h1>KiCad Libraries</h1>
    <p class="subtitle">Manage symbols, footprints, and 3D models</p>
</div>

<div class="libs-upload-zone" id="uploadZone">
    <div class="upload-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
    </div>
    <p>Drag & drop files here or <label for="fileInput" class="upload-link">browse</label></p>
    <p class="upload-hint">.kicad_sym, .kicad_mod, .step, .stp, .wrl</p>
    <input type="file" id="fileInput" multiple accept=".kicad_sym,.kicad_mod,.step,.stp,.wrl" style="display:none">
</div>

<div class="libs-grid">
    <div class="libs-section">
        <h2>Symbols <span class="count" id="symbolCount">0</span></h2>
        <div class="libs-list" id="symbolsList">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <div class="libs-section">
        <h2>Footprints <span class="count" id="footprintCount">0</span></h2>
        <div class="libs-list" id="footprintsList">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <div class="libs-section">
        <h2>3D Models <span class="count" id="modelCount">0</span></h2>
        <div class="libs-list" id="modelsList">
            <div class="loading">Loading...</div>
        </div>
    </div>
</div>

<style>
    .libs-upload-zone {
        border: 2px dashed var(--border);
        border-radius: var(--radius);
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        transition: all .2s;
        background: var(--surface);
    }

    .libs-upload-zone.dragover {
        border-color: var(--accent);
        background: var(--surface2);
    }

    .upload-icon {
        color: var(--text-dim);
        margin-bottom: .5rem;
    }

    .libs-upload-zone p {
        margin: .3rem 0;
        color: var(--text-dim);
    }

    .upload-link {
        color: var(--accent);
        cursor: pointer;
        text-decoration: underline;
    }

    .upload-hint {
        font-size: .8rem;
        color: var(--text-dim);
    }

    .libs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .libs-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
    }

    .libs-section h2 {
        font-size: 1rem;
        padding: .75rem 1rem;
        background: var(--surface2);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: .5rem;
    }

    .libs-section h2 .count {
        background: var(--accent);
        color: #fff;
        font-size: .75rem;
        padding: .1rem .5rem;
        border-radius: 10px;
    }

    .libs-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .lib-item {
        display: flex;
        align-items: center;
        padding: .6rem 1rem;
        border-bottom: 1px solid var(--border);
        gap: .75rem;
    }

    .lib-item:last-child {
        border-bottom: none;
    }

    .lib-item:hover {
        background: var(--surface2);
    }

    .lib-icon {
        color: var(--text-dim);
        flex-shrink: 0;
    }

    .lib-info {
        flex: 1;
        min-width: 0;
    }

    .lib-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .lib-meta {
        font-size: .75rem;
        color: var(--text-dim);
    }

    .lib-actions {
        display: flex;
        gap: .3rem;
    }

    .lib-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        padding: .3rem;
        border-radius: 4px;
    }

    .lib-btn:hover {
        background: var(--border);
        color: var(--text);
    }

    .lib-btn.delete:hover {
        color: var(--red);
    }

    .loading,
    .empty {
        padding: 1rem;
        text-align: center;
        color: var(--text-dim);
        font-size: .85rem;
    }
</style>

<script>
    (function () {
        var uploadZone = document.getElementById('uploadZone');
        var fileInput = document.getElementById('fileInput');
        var symbolsList = document.getElementById('symbolsList');
        var footprintsList = document.getElementById('footprintsList');
        var modelsList = document.getElementById('modelsList');
        var symbolCount = document.getElementById('symbolCount');
        var footprintCount = document.getElementById('footprintCount');
        var modelCount = document.getElementById('modelCount');

        // Load libraries
        function loadLibs() {
            fetch('/api/v1/libs')
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    renderList(symbolsList, data.symbols, 'symbols', symbolCount);
                    renderList(footprintsList, data.footprints, 'footprints', footprintCount);
                    renderList(modelsList, data['3dmodels'], '3dmodels', modelCount);
                });
        }

        function renderList(container, items, type, countEl) {
            countEl.textContent = items.length;
            if (items.length === 0) {
                container.innerHTML = '<div class="empty">No files yet</div>';
                return;
            }
            container.innerHTML = items.map(function (item) {
                var size = (item.size / 1024).toFixed(1) + ' KB';
                return '<div class="lib-item">' +
                    '<div class="lib-icon">' + getIcon(type) + '</div>' +
                    '<div class="lib-info">' +
                    '<div class="lib-name">' + escapeHtml(item.name) + '</div>' +
                    '<div class="lib-meta">' + escapeHtml(item.filename) + ' - ' + size + '</div>' +
                    '</div>' +
                    '<div class="lib-actions">' +
                    '<a href="' + item.url + '" class="lib-btn" title="Download" download>' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>' +
                    '</a>' +
                    '<button class="lib-btn delete" title="Delete" onclick="deleteFile(\'' + type + '\', \'' + item.filename + '\')">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
                    '</button>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function getIcon(type) {
            if (type === 'symbols') {
                return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="3" x2="12" y2="9"/><line x1="12" y1="15" x2="12" y2="21"/><line x1="3" y1="12" x2="9" y2="12"/><line x1="15" y1="12" x2="21" y2="12"/></svg>';
            } else if (type === 'footprints') {
                return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="6" cy="12" r="2"/><circle cx="18" cy="12" r="2"/></svg>';
            } else {
                return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>';
            }
        }

        // Drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function (evt) {
            uploadZone.addEventListener(evt, function (e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        uploadZone.addEventListener('dragenter', function () { uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragover', function () { uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', function () { uploadZone.classList.remove('dragover'); });
        uploadZone.addEventListener('drop', function (e) {
            uploadZone.classList.remove('dragover');
            var files = e.dataTransfer.files;
            uploadFiles(files);
        });

        fileInput.addEventListener('change', function () {
            uploadFiles(fileInput.files);
            fileInput.value = '';
        });

        function uploadFiles(files) {
            Array.from(files).forEach(function (file) {
                var formData = new FormData();
                formData.append('file', file);

                fetch('/api/v1/libs/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        if (data.success) {
                            loadLibs();
                        } else {
                            alert('Upload failed: ' + data.error);
                        }
                    })
                    .catch(function (err) {
                        alert('Upload error: ' + err);
                    });
            });
        }

        // Delete
        window.deleteFile = function (type, filename) {
            if (!confirm('Delete ' + filename + '?')) return;
            fetch('/api/v1/libs/' + type + '/' + filename, { method: 'DELETE' })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.success) {
                        loadLibs();
                    } else {
                        alert('Delete failed: ' + data.error);
                    }
                });
        };

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        loadLibs();
    })();
</script>
{% endblock %}